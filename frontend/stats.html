<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2a004f">
    <title>Tracker Statistics</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <script src="libs/chart.umd.min.js"></script>
    <script src="libs/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Statistics</h1>
            <div class="nav-buttons">
                <a href="index.html" class="nav-link">Log Data üìù</a>
                <button class="hamburger-menu" id="hamburger-btn" aria-label="Menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
        </div>
        <nav class="dropdown-menu" id="dropdown-menu">
            <a href="register.html" class="dropdown-item" id="register-link" style="display: none;">Register User üë•</a>
            <a href="#" id="logout-btn" class="dropdown-item">Logout üö™</a>
        </nav>
        
        <div class="charts-grid">
            <div class="chart-container">
                <canvas id="weightChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="bodyFatChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="muscleChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="visceralFatChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="sleepChart"></canvas>
            </div>
        </div>

        <h2 style="margin-top: 40px; text-align: center; color: #fff;">Body Measurements</h2>
        <div class="charts-grid">
            <div class="chart-container">
                <canvas id="upperArmChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="chestWaistChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="thighChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="faceNeckChart"></canvas>
            </div>
        </div>

        <div class="table-container">
            <h2>All Logs</h2>
            <table id="logsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Weight</th>
                        <th>Body Fat</th>
                        <th>Muscle</th>
                        <th>Visceral Fat</th>
                        <th>Sleep</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <h2>All Jabs</h2>
            <table id="jabsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Dose (mg)</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <h2>All Body Measurements</h2>
            <table id="measurementsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Upper Arm L</th>
                        <th>Upper Arm R</th>
                        <th>Chest</th>
                        <th>Waist</th>
                        <th>Thigh L</th>
                        <th>Thigh R</th>
                        <th>Face</th>
                        <th>Neck</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Log Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Edit Log Entry</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-log-id">
                <div class="form-group">
                    <label for="edit-weight">Weight (kg)</label>
                    <input type="number" step="0.1" id="edit-weight" name="weight">
                </div>
                <div class="form-group">
                    <label for="edit-body_fat">Body Fat (%)</label>
                    <input type="number" step="0.1" id="edit-body_fat" name="body_fat">
                </div>
                <div class="form-group">
                    <label for="edit-muscle">Muscle (%)</label>
                    <input type="number" step="0.1" id="edit-muscle" name="muscle">
                </div>
                <div class="form-group">
                    <label for="edit-visceral_fat">Visceral Fat</label>
                    <input type="number" id="edit-visceral_fat" name="visceral_fat">
                </div>
                <div class="form-group">
                    <label for="edit-sleep">Sleep (hours)</label>
                    <input type="number" step="0.1" id="edit-sleep" name="sleep">
                </div>
                <div class="form-group">
                    <label for="edit-notes">Notes</label>
                    <textarea id="edit-notes" name="notes" rows="3"></textarea>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Edit Jab Modal -->
    <div id="editJabModal" class="modal">
        <div class="modal-content">
            <span class="close-jab-button">&times;</span>
            <h2>Edit Jab Entry</h2>
            <form id="edit-jab-form">
                <input type="hidden" id="edit-jab-id">
                <div class="form-group">
                    <label for="edit-jab-dose">Dose (mg)</label>
                    <input type="number" step="0.1" id="edit-jab-dose" name="dose" required>
                </div>
                <div class="form-group">
                    <label for="edit-jab-notes">Notes</label>
                    <textarea id="edit-jab-notes" name="notes" rows="3"></textarea>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Edit Body Measurement Modal -->
    <div id="editMeasurementModal" class="modal">
        <div class="modal-content">
            <span class="close-measurement-button">&times;</span>
            <h2>Edit Body Measurement</h2>
            <form id="edit-measurement-form">
                <input type="hidden" id="edit-measurement-id">
                <div class="form-group">
                    <label for="edit-upper_arm_left">Upper Arm Left (cm)</label>
                    <input type="number" step="0.1" id="edit-upper_arm_left" name="upper_arm_left">
                </div>
                <div class="form-group">
                    <label for="edit-upper_arm_right">Upper Arm Right (cm)</label>
                    <input type="number" step="0.1" id="edit-upper_arm_right" name="upper_arm_right">
                </div>
                <div class="form-group">
                    <label for="edit-chest">Chest (cm)</label>
                    <input type="number" step="0.1" id="edit-chest" name="chest">
                </div>
                <div class="form-group">
                    <label for="edit-waist">Waist (cm)</label>
                    <input type="number" step="0.1" id="edit-waist" name="waist">
                </div>
                <div class="form-group">
                    <label for="edit-thigh_left">Thigh Left (cm)</label>
                    <input type="number" step="0.1" id="edit-thigh_left" name="thigh_left">
                </div>
                <div class="form-group">
                    <label for="edit-thigh_right">Thigh Right (cm)</label>
                    <input type="number" step="0.1" id="edit-thigh_right" name="thigh_right">
                </div>
                <div class="form-group">
                    <label for="edit-face">Face (cm)</label>
                    <input type="number" step="0.1" id="edit-face" name="face">
                </div>
                <div class="form-group">
                    <label for="edit-neck">Neck (cm)</label>
                    <input type="number" step="0.1" id="edit-neck" name="neck">
                </div>
                <div class="form-group">
                    <label for="edit-measurement-notes">Notes</label>
                    <textarea id="edit-measurement-notes" name="notes" rows="3"></textarea>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <script src="stats.js"></script>
    <script>
        // Check if current user is admin and show register link
        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.is_admin) {
                        document.getElementById('register-link').style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        checkAdminStatus();

        // Hamburger menu functionality
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const dropdownMenu = document.getElementById('dropdown-menu');

        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
            hamburgerBtn.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!hamburgerBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/login.html';
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
